<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Registration CSV Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #0586e8 100%);
            padding: 20px;
            min-height: 100vh;
        }

        /* full-desktop two-column layout */
        html,body{height:100%;}
        .container {
            width: calc(100% - 200px);
            max-width: none;
            height: calc(100vh - 80px);
            margin: 20px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: grid;
            grid-template-columns: 1fr 50%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #18b2ef 100%);
            color: white;
            padding: 18px 24px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:12px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .form-container {
            padding: 24px 30px;
            overflow-y: auto;
            height: calc(100vh - 140px);
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }
        .last-field{
            margin-bottom: 100px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        label .required {
            color: #e74c3c;
            margin-left: 3px;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input.error,
        select.error {
            border-color: #e74c3c;
        }

        input.success,
        select.success {
            border-color: #2ecc71;
        }

        .error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            color: #2ecc71;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .radio-group,
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-group label,
        .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            cursor: pointer;
        }

        .radio-group input,
        .checkbox-group input {
            width: auto;
            margin-right: 8px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding: 14px 22px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            position: sticky; bottom: 0; z-index:5;
        }

        /* right column */
        .records-panel { background: #fafafa; overflow:auto; height:100%; }
        #recordsTable button{ margin-right:6px; padding:6px 8px; border-radius:6px; border:0; cursor:pointer }
        #recordsTable button:nth-child(1){ background:#ffc107 }
        #recordsTable button:nth-child(2){ background:#17a2b8; color:#fff }
        #recordsTable button:nth-child(3){ background:#dc3545; color:#fff }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .records-count {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
            margin: 10px 0;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1100px) {
            .container{grid-template-columns:1fr}
            .records-panel{order:3}
            .form-container{height:auto}
        }

        .field-hint {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 3px;
        }

        input:disabled,
        select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="grid-column:1 / -1;">
            <div style="display:flex;flex-direction:column;gap:6px;">
                <h1 style="font-size:22px;margin-bottom:0;">üè¢ Business Registration <b>(Step 1)</b>  </h1>
                <p style="opacity:0.95;font-size:13px;margin-top:2px;">Fill out the form below to generate your CSV file</p>
            </div>

            <div style="display:flex;gap:10px;align-items:center;">
                <div style="display:flex;flex-direction:column;align-items:flex-end;">
                    <label style="font-size:12px;opacity:0.9;margin-bottom:6px">Default BIN Prefix (first 7 digits)</label>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <input id="defaultBinPrefix" type="text" placeholder="e.g. 1001301" maxlength="7" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.25);width:120px;background:rgba(255,255,255,0.06);color:#fff">
                        <button id="clearDefaultPrefix" style="padding:8px 10px;border-radius:6px;border:none;background:rgba(255,255,255,0.15);color:#fff;cursor:pointer">Clear</button>
                    </div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <a href="business-activity.html" style="background:rgba(255,255,255,0.2);color:white;padding:8px 16px;border-radius:6px;text-decoration:none;font-size:14px;cursor:pointer;border:none;transition:all 0.3s;display:inline-block" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">Step 2: Activity</a>
                    <a href="permit-application.html" style="background:rgba(255,255,255,0.2);color:white;padding:8px 16px;border-radius:6px;text-decoration:none;font-size:14px;cursor:pointer;border:none;transition:all 0.3s;display:inline-block" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">Step 3: Permit ‚Üí</a>
                </div>
                <div style="text-align:right">
                    <div class="records-count" id="recordCount">Records: 0</div>
                </div>
            </div>
        </div>

        <form id="businessForm">
            <div class="form-container">
                <!-- BUSINESS INFORMATION -->
                <div class="section-title">üìã Business Information</div>

                <div class="form-group">
                    <label>BIN <span class="required">*</span></label>
                    <input type="text" id="bin" placeholder="0000000-0000-0000000" maxlength="22">
                    <div class="field-hint">Format: 0000000-0000-0000000</div>
                    <div class="error-message" id="bin-error"></div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Business Name <span class="required">*</span></label>
                        <input type="text" id="business_name" placeholder="Enter business name" maxlength="100">
                        <div class="error-message" id="business_name-error"></div>
                    </div>

                    <div class="form-group">
                        <label>Trade Name</label>
                        <input type="text" id="trade_name" placeholder="Optional" maxlength="100">
                    </div>
                </div>

                <div class="form-group">
                    <label>Business Type <span class="required">*</span></label>
                    <select id="business_type">
                        <option value="">Select business type</option>
                        <option value="SOLE PROPRIETORSHIP">SOLE PROPRIETORSHIP</option>
                        <option value="ONE PERSON CORPORATION">ONE PERSON CORPORATION</option>
                        <option value="PARTNERSHIP">PARTNERSHIP</option>
                        <option value="CORPORATION">CORPORATION</option>
                        <option value="COOPERATIVE">COOPERATIVE</option>
                    </select>
                    <div class="error-message" id="business_type-error"></div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>DTI Number <span id="dti-required"></span></label>
                        <input type="text" id="dti_no" placeholder="DTI Registration Number" maxlength="30" disabled>
                        <div class="error-message" id="dti_no-error"></div>
                    </div>

                    <div class="form-group">
                        <label>SEC Number <span id="sec-required"></span></label>
                        <input type="text" id="sec_no" placeholder="SEC Registration Number" maxlength="30" disabled>
                        <div class="error-message" id="sec_no-error"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>CDA Number <span id="cda-required"></span></label>
                        <input type="text" id="cda_no" placeholder="CDA Registration Number" maxlength="30" disabled>
                        <div class="error-message" id="cda_no-error"></div>
                    </div>

                    <div class="form-group">
                        <label>TIN</label>
                        <input type="text" id="tin_no" placeholder="000-000-000-00000" maxlength="17">
                        <div class="field-hint">Format: 000-000-000-00000</div>
                        <div class="error-message" id="tin_no-error"></div>
                    </div>
                </div>

                <!-- CONTACT INFORMATION -->
                <div class="section-title">üìû Contact Information</div>

                <div class="row">
                    <div class="form-group">
                        <label>Email Address <span class="required">*</span></label>
                        <input type="email" id="email_address" placeholder="email@example.com">
                        <div class="error-message" id="email_address-error"></div>
                    </div>

                    <div class="form-group">
                        <label>Cellphone <span class="required">*</span></label>
                        <input type="text" id="cellphone_no" placeholder="639XXXXXXXXX" maxlength="12">
                        <div class="field-hint">Format: 639XXXXXXXXX</div>
                        <div class="error-message" id="cellphone_no-error"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Telephone</label>
                    <input type="text" id="telephone_no" placeholder="Optional" maxlength="20">
                </div>

                <!-- PERSON IN CHARGE -->
                <div class="section-title">üë§ Person in Charge</div>

                <div class="row">
                    <div class="form-group">
                        <label>First Name <span class="required">*</span></label>
                        <input type="text" id="incharge_first_name" maxlength="100">
                        <div class="error-message" id="incharge_first_name-error"></div>
                    </div>

                    <div class="form-group">
                        <label>Middle Name</label>
                        <input type="text" id="incharge_middle_name" maxlength="100">
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Last Name <span class="required">*</span></label>
                        <input type="text" id="incharge_last_name" maxlength="100">
                        <div class="error-message" id="incharge_last_name-error"></div>
                    </div>

                    <div class="form-group">
                        <label>Extension Name</label>
                        <input type="text" id="incharge_extension_name" placeholder="JR, SR, III (no period)" maxlength="100">
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Sex <span class="required">*</span></label>
                        <div class="radio-group">
                            <label><input type="radio" name="incharge_sex" value="M"> Male</label>
                            <label><input type="radio" name="incharge_sex" value="F"> Female</label>
                        </div>
                        <div class="error-message" id="incharge_sex-error"></div>
                    </div>

                    <div class="form-group">
                        <label>Country of Citizenship <span class="required">*</span></label>
                        <input type="text" id="incharge_country_of_citizenship" value="PHL" maxlength="100">
                        <div class="error-message" id="incharge_country_of_citizenship-error"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Street Address</label>
                    <input type="text" id="incharge_street" placeholder="Optional" maxlength="100">
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Barangay</label>
                        <input type="text" id="incharge_barangay" maxlength="100">
                    </div>

                    <div class="form-group">
                        <label>Municipality</label>
                        <input type="text" id="incharge_municipality" maxlength="100">
                    </div>
                </div>

                <div class="form-group">
                    <label>Province</label>
                    <input type="text" id="incharge_province" maxlength="100">
                </div>

                <!-- OFFICE ADDRESS -->
                <div class="section-title">üè¢ Office Address</div>

                <div class="form-group">
                    <label>Office Street</label>
                    <input type="text" id="office_street" maxlength="100">
                </div>

                <div class="form-group">
                    <label>Office Barangay Code <span class="required">*</span></label>
                    <input type="text" id="office_barangay_code" placeholder="Geocode of Barangay">
                    <div class="error-message" id="office_barangay_code-error"></div>
                </div>

                <div class="form-group">
                    <label>Location <span class="required">*</span></label>
                    <div class="radio-group">
                        <label><input type="radio" name="location_owned" value="1"> Owned</label>
                        <label><input type="radio" name="location_owned" value="0"> Rented</label>
                    </div>
                    <div class="error-message" id="location_owned-error"></div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>TDN Number <span id="tdn-required"></span></label>
                        <input type="text" id="tdn_no" maxlength="20" disabled>
                        <div class="error-message" id="tdn_no-error"></div>
                    </div>

                    <div class="form-group">
                        <label>PIN Number <span id="pin-required"></span></label>
                        <input type="text" id="pin_no" maxlength="20" disabled>
                        <div class="error-message" id="pin_no-error"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Lessor Name <span id="lessor-required"></span></label>
                        <input type="text" id="lessor_name" maxlength="150" disabled>
                        <div class="error-message" id="lessor_name-error"></div>
                    </div>

                    <div class="form-group">
                        <label>Monthly Rental <span id="rental-required"></span></label>
                        <input type="number" id="monthly_rental" min="0" disabled>
                        <div class="error-message" id="monthly_rental-error"></div>
                    </div>
                </div>

                <!-- BUSINESS DETAILS -->
                <div class="section-title">üìä Business Details</div>

                <div class="form-group">
                    <label>Total Floor Area (sqm) <span class="required">*</span></label>
                    <input type="number" id="area" min="0">
                    <div class="error-message" id="area-error"></div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Male Employees <span class="required">*</span></label>
                        <input type="number" id="no_of_male_employees" min="0" value="0">
                        <div class="error-message" id="no_of_male_employees-error"></div>
                    </div>

                    <div class="form-group">
                        <label>Female Employees <span class="required">*</span></label>
                        <input type="number" id="no_of_female_employees" min="0" value="0">
                        <div class="error-message" id="no_of_female_employees-error"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Employees within LGU <span class="required">*</span></label>
                    <input type="number" id="no_of_employees_residing_within_the_area" min="0" value="0">
                    <div class="field-hint" id="employee-hint">Must not exceed total employees</div>
                    <div class="error-message" id="no_of_employees_residing_within_the_area-error"></div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Number of Vans <span class="required">*</span></label>
                        <input type="number" id="no_of_van" min="0" value="0">
                    </div>

                    <div class="form-group">
                        <label>Number of Trucks <span class="required">*</span></label>
                        <input type="number" id="no_of_truck" min="0" value="0">
                    </div>
                </div>

                <div class="form-group">
                    <label>Number of Motorcycles <span class="required">*</span></label>
                    <input type="number" id="no_of_motorcycle" min="0" value="0">
                </div>
                <div class="form-group last-field">
                    <label>Activity Type <span class="required">*</span></label>
                    <select id="activity_type">
                        <option value="">Select activity type</option>
                        <option value="Main Office">Main Office</option>
                        <option value="Branch Office">Branch Office</option>
                        <option value="Admin Office Only">Admin Office Only</option>
                        <option value="Warehouse">Warehouse</option>
                        <option value="Others">Others</option>
                    </select>
                    <div class="error-message" id="activity_type-error"></div>
                </div>

                
            </div>

            <div class="button-group">
                <button type="button" class="btn-primary" onclick="addRecord()">‚ûï Add Record</button>
                <button type="button" class="btn-secondary" onclick="clearForm()">üîÑ Clear Form</button>
                <button type="button" class="btn-success" onclick="generateCSV()">üíæ Generate CSV</button>
            </div>
        </form>

        <div class="records-panel" id="recordsPanel" style="padding:20px 30px;border-top:1px solid #eee;">
            <div class="section-title">üíæ Saved Records</div>
            <div style="padding:10px 0 20px 0;">
                <input type="text" id="searchRecords" placeholder="Search by business name or BIN..." style="width:100%;padding:10px;margin-bottom:10px;border-radius:6px;border:1px solid #ddd;">
                <table id="recordsTable" style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="text-align:left;border-bottom:1px solid #e6e6e6;padding-bottom:8px;">
                            <th style="padding:8px">#</th>
                            <th style="padding:8px">BIN</th>
                            <th style="padding:8px">Business Name</th>
                            <th style="padding:8px">Type</th>
                            <th style="padding:8px">In-Charge</th>
                            <th style="padding:8px">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    // Storage keys
    const STORAGE_KEY = 'business_records_v1';
    const PREFIX_KEY = 'default_bin_prefix_v1';

    let records = loadRecords();
    let editingIndex = null; // when editing a record
    let defaultBinPrefix = '';

        // Real-time validation patterns
        const patterns = {
            bin: /^\d{7}-\d{4}-\d{7}$/,
            email: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
            cellphone: /^639\d{9}$/,
            tin: /^\d{3}-\d{3}-\d{3}-\d{5}$/
        };

        // Initialize UI
        document.addEventListener('DOMContentLoaded', () => {
            // load default prefix
            try{ defaultBinPrefix = localStorage.getItem(PREFIX_KEY) || ''; }catch(e){ defaultBinPrefix = ''; }
            document.getElementById('defaultBinPrefix').value = defaultBinPrefix;

            renderTable();
            updateRecordCount();

            // if default prefix exists and bin empty, prefill
            const binEl = document.getElementById('bin');
            if(defaultBinPrefix && (!binEl.value || binEl.value.trim()==='')){
                binEl.value = defaultBinPrefix + '-';
            }
        });

        // Default prefix input handlers
        document.getElementById('defaultBinPrefix').addEventListener('input', function(e){
            // allow only digits and max 7
            this.value = this.value.replace(/\D/g,'').slice(0,7);
            defaultBinPrefix = this.value;
            try{ localStorage.setItem(PREFIX_KEY, defaultBinPrefix); }catch(e){/*ignore*/}
        });
        document.getElementById('clearDefaultPrefix').addEventListener('click', function(){
            defaultBinPrefix = '';
            try{ localStorage.removeItem(PREFIX_KEY); }catch(e){}
            document.getElementById('defaultBinPrefix').value = '';
        });

        function loadRecords(){
            try{
                const raw = localStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : [];
            }catch(e){
                console.error('Failed to load records', e);
                return [];
            }
        }

        function saveRecords(){
            try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(records)); }catch(e){ console.error('Failed to save', e); }
        }

        // Format BIN input
        document.getElementById('bin').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d]/g, '');
            if (value.length > 7) {
                value = value.slice(0, 7) + '-' + value.slice(7);
            }
            if (value.length > 12) {
                value = value.slice(0, 12) + '-' + value.slice(12);
            }
            e.target.value = value.slice(0, 22);
            validateField('bin', e.target.value);
        });

        // When bin gets focus, if default prefix exists and bin is empty or doesn't start with it, prefill it
        document.getElementById('bin').addEventListener('focus', function(){
            const el = this;
            if(defaultBinPrefix){
                const raw = el.value.replace(/[^\d]/g,'');
                // if doesn't start with prefix digits, prefill prefix
                if(!raw.startsWith(defaultBinPrefix)){
                    el.value = defaultBinPrefix + (raw.length>7 ? ('-' + raw.slice(7)) : '-');
                    // trigger input formatting
                    el.dispatchEvent(new Event('input'));
                }
            }
        });

        // Format TIN input
        document.getElementById('tin_no').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d]/g, '');
            if (value.length > 3) value = value.slice(0, 3) + '-' + value.slice(3);
            if (value.length > 7) value = value.slice(0, 7) + '-' + value.slice(7);
            if (value.length > 11) value = value.slice(0, 11) + '-' + value.slice(11);
            e.target.value = value.slice(0, 17);
            if (e.target.value) validateField('tin_no', e.target.value);
        });

        // Format cellphone input
        document.getElementById('cellphone_no').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^\d]/g, '').slice(0, 12);
            validateField('cellphone_no', e.target.value);
        });

        // Email validation
        document.getElementById('email_address').addEventListener('blur', function(e) {
            validateField('email_address', e.target.value);
        });

        // Business type change
        document.getElementById('business_type').addEventListener('change', function() {
            const type = this.value;
            const dti = document.getElementById('dti_no');
            const sec = document.getElementById('sec_no');
            const cda = document.getElementById('cda_no');

            // Reset all
            dti.disabled = true;
            sec.disabled = true;
            cda.disabled = true;
            dti.value = '';
            sec.value = '';
            cda.value = '';
            document.getElementById('dti-required').innerHTML = '';
            document.getElementById('sec-required').innerHTML = '';
            document.getElementById('cda-required').innerHTML = '';

            // Enable based on type
            if (type === 'SOLE PROPRIETORSHIP') {
                dti.disabled = false;
                document.getElementById('dti-required').innerHTML = '<span class="required">*</span>';
            } else if (type === 'ONE PERSON CORPORATION' || type === 'PARTNERSHIP' || type === 'CORPORATION') {
                sec.disabled = false;
                document.getElementById('sec-required').innerHTML = '<span class="required">*</span>';
            } else if (type === 'COOPERATIVE') {
                cda.disabled = false;
                document.getElementById('cda-required').innerHTML = '<span class="required">*</span>';
            }
        });

        // Location ownership change
        document.querySelectorAll('input[name="location_owned"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const isOwned = this.value === '1';
                const tdn = document.getElementById('tdn_no');
                const pin = document.getElementById('pin_no');
                const lessor = document.getElementById('lessor_name');
                const rental = document.getElementById('monthly_rental');

                if (isOwned) {
                    tdn.disabled = false;
                    pin.disabled = false;
                    lessor.disabled = true;
                    rental.disabled = true;
                    lessor.value = '';
                    rental.value = '';
                    document.getElementById('tdn-required').innerHTML = '<span class="required">*</span>';
                    document.getElementById('pin-required').innerHTML = '<span class="required">*</span>';
                    document.getElementById('lessor-required').innerHTML = '';
                    document.getElementById('rental-required').innerHTML = '';
                } else {
                    tdn.disabled = true;
                    pin.disabled = true;
                    lessor.disabled = false;
                    rental.disabled = false;
                    tdn.value = '';
                    pin.value = '';
                    document.getElementById('tdn-required').innerHTML = '';
                    document.getElementById('pin-required').innerHTML = '';
                    document.getElementById('lessor-required').innerHTML = '<span class="required">*</span>';
                    document.getElementById('rental-required').innerHTML = '<span class="required">*</span>';
                }
            });
        });

        // Employee count validation
        ['no_of_male_employees', 'no_of_female_employees', 'no_of_employees_residing_within_the_area'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                const male = parseInt(document.getElementById('no_of_male_employees').value) || 0;
                const female = parseInt(document.getElementById('no_of_female_employees').value) || 0;
                const total = male + female;
                const inLGU = parseInt(document.getElementById('no_of_employees_residing_within_the_area').value) || 0;

                document.getElementById('employee-hint').textContent = `Must not exceed total employees (${total})`;

                if (inLGU > total) {
                    showError('no_of_employees_residing_within_the_area', `Cannot exceed total employees (${total})`);
                } else {
                    clearError('no_of_employees_residing_within_the_area');
                }
            });
        });

        function validateField(fieldId, value) {
            const field = document.getElementById(fieldId);
            
            if (fieldId === 'bin') {
                if (!patterns.bin.test(value)) {
                    showError(fieldId, 'Invalid format. Use: 0000000-0000-0000000');
                    return false;
                } else {
                    clearError(fieldId);
                    return true;
                }
            }

            if (fieldId === 'email_address') {
                if (!patterns.email.test(value)) {
                    showError(fieldId, 'Invalid email format');
                    return false;
                } else {
                    clearError(fieldId);
                    return true;
                }
            }

            if (fieldId === 'cellphone_no') {
                if (!patterns.cellphone.test(value)) {
                    showError(fieldId, 'Must start with 639 and have 12 digits');
                    return false;
                } else {
                    clearError(fieldId);
                    return true;
                }
            }

            if (fieldId === 'tin_no' && value) {
                if (!patterns.tin.test(value)) {
                    showError(fieldId, 'Invalid format. Use: 000-000-000-00000');
                    return false;
                } else {
                    clearError(fieldId);
                    return true;
                }
            }

            return true;
        }

        function showError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(fieldId + '-error');
            if(field) field.classList.add('error');
            if(field) field.classList.remove('success');
            if(error){ error.textContent = message; error.classList.add('show'); }
        }

        function clearError(fieldId) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(fieldId + '-error');
            if(field) field.classList.remove('error');
            if(field) field.classList.add('success');
            if(error) error.classList.remove('show');
        }

        // Render table (show BIN column)
        function renderTable(filter=''){
            const tbody = document.querySelector('#recordsTable tbody');
            tbody.innerHTML = '';
            records.forEach((rec, idx) => {
                if(filter){
                    const q = filter.toLowerCase();
                    if(!( (rec.business_name||'').toLowerCase().includes(q) || (rec.bin||'').toLowerCase().includes(q) )) return;
                }
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding:8px;border-bottom:1px solid #f0f0f0">${idx+1}</td>
                    <td style="padding:8px;border-bottom:1px solid #f0f0f0">${escapeHtml(rec.bin||'')}</td>
                    <td style="padding:8px;border-bottom:1px solid #f0f0f0">${escapeHtml(rec.business_name||'')}</td>
                    <td style="padding:8px;border-bottom:1px solid #f0f0f0">${escapeHtml(rec.business_type||'')}</td>
                    <td style="padding:8px;border-bottom:1px solid #f0f0f0">${escapeHtml((rec.incharge_first_name||'') + ' ' + (rec.incharge_last_name||''))}</td>
                    <td style="padding:8px;border-bottom:1px solid #f0f0f0">
                        <button onclick="editRecord(${idx})">Edit</button>
                        <button onclick="duplicateRecord(${idx})">Duplicate</button>
                        <button onclick="deleteRecord(${idx})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        // Search
        document.getElementById('searchRecords').addEventListener('input', function(){ renderTable(this.value); });

        // addRecord now supports editing
        function addRecord() {
            // ensure default prefix applied to BIN before validation
            ensurePrefixApplied();

            // Validate all required fields
            let isValid = true;
            let errors = [];

            // BIN
            if (!document.getElementById('bin').value || !validateField('bin', document.getElementById('bin').value)) {
                showError('bin', 'BIN is required and must match format');
                isValid = false;
                errors.push('‚ùå BIN: Must be in format 0000000-0000-0000000');
            }

            // Business Name
            const businessName = document.getElementById('business_name').value;
            if (!businessName || businessName.length < 3) {
                showError('business_name', 'Business name must be at least 3 characters');
                isValid = false;
                errors.push('‚ùå Business Name: Must be at least 3 characters');
            }

            // Business Type
            const businessType = document.getElementById('business_type').value;
            if (!businessType) {
                showError('business_type', 'Business type is required');
                isValid = false;
                errors.push('‚ùå Business Type: Please select a type');
            }

            // Conditional registration numbers
            if (businessType === 'SOLE PROPRIETORSHIP' && !document.getElementById('dti_no').value) {
                showError('dti_no', 'DTI number is required for Sole Proprietorship');
                isValid = false;
                errors.push('‚ùå DTI Number: Required for Sole Proprietorship');
            }
            if ((businessType === 'ONE PERSON CORPORATION' || businessType === 'PARTNERSHIP' || businessType === 'CORPORATION') && !document.getElementById('sec_no').value) {
                showError('sec_no', 'SEC number is required for this business type');
                isValid = false;
                errors.push('‚ùå SEC Number: Required for ' + businessType);
            }
            if (businessType === 'COOPERATIVE' && !document.getElementById('cda_no').value) {
                showError('cda_no', 'CDA number is required for Cooperative');
                isValid = false;
                errors.push('‚ùå CDA Number: Required for Cooperative');
            }

            // Email
            const email = document.getElementById('email_address').value;
            if (!email || !validateField('email_address', email)) {
                showError('email_address', 'Valid email is required');
                isValid = false;
                errors.push('‚ùå Email Address: Must be a valid email (e.g., name@domain.com)');
            }

            // Cellphone
            const cellphone = document.getElementById('cellphone_no').value;
            if (!cellphone || !validateField('cellphone_no', cellphone)) {
                showError('cellphone_no', 'Valid cellphone is required');
                isValid = false;
                errors.push('‚ùå Cellphone: Must start with 639 and have 12 digits (e.g., 639XXXXXXXXX)');
            }

            // Person in charge
            if (!document.getElementById('incharge_first_name').value) {
                showError('incharge_first_name', 'First name is required');
                isValid = false;
                errors.push('‚ùå First Name: Required');
            }
            if (!document.getElementById('incharge_last_name').value) {
                showError('incharge_last_name', 'Last name is required');
                isValid = false;
                errors.push('‚ùå Last Name: Required');
            }

            const sex = document.querySelector('input[name="incharge_sex"]:checked');
            if (!sex) {
                showError('incharge_sex', 'Sex is required');
                isValid = false;
                errors.push('‚ùå Sex: Please select Male or Female');
            }

            if (!document.getElementById('incharge_country_of_citizenship').value) {
                showError('incharge_country_of_citizenship', 'Country of citizenship is required');
                isValid = false;
                errors.push('‚ùå Country of Citizenship: Required');
            }

            // Office barangay code
            if (!document.getElementById('office_barangay_code').value) {
                showError('office_barangay_code', 'Office barangay code is required');
                isValid = false;
                errors.push('‚ùå Office Barangay Code: Required');
            }

            // Location ownership
            const locationOwned = document.querySelector('input[name="location_owned"]:checked');
            if (!locationOwned) {
                showError('location_owned', 'Location ownership is required');
                isValid = false;
                errors.push('‚ùå Location: Please select Owned or Rented');
            } else {
                if (locationOwned.value === '1') {
                    if (!document.getElementById('tdn_no').value && !document.getElementById('pin_no').value) {
                        showError('tdn_no', 'Either TDN or PIN is required for owned property');
                        showError('pin_no', 'Either TDN or PIN is required for owned property');
                        isValid = false;
                        errors.push('‚ùå TDN/PIN: At least one is required for Owned property');
                    }
                } else {
                    if (!document.getElementById('lessor_name').value) {
                        showError('lessor_name', 'Lessor name is required for rented property');
                        isValid = false;
                        errors.push('‚ùå Lessor Name: Required for Rented property');
                    }
                    if (!document.getElementById('monthly_rental').value) {
                        showError('monthly_rental', 'Monthly rental is required for rented property');
                        isValid = false;
                        errors.push('‚ùå Monthly Rental: Required for Rented property');
                    }
                }
            }

            // Area
            if (!document.getElementById('area').value) {
                showError('area', 'Total floor area is required');
                isValid = false;
                errors.push('‚ùå Total Floor Area: Required');
            }

            // Employees
            const male = parseInt(document.getElementById('no_of_male_employees').value) || 0;
            const female = parseInt(document.getElementById('no_of_female_employees').value) || 0;
            const inLGU = parseInt(document.getElementById('no_of_employees_residing_within_the_area').value) || 0;
            
            if (inLGU > (male + female)) {
                showError('no_of_employees_residing_within_the_area', `Cannot exceed total employees (${male + female})`);
                isValid = false;
                errors.push(`‚ùå Employees within LGU: Cannot exceed total (${male + female})`);
            }

            // Activity type
            if (!document.getElementById('activity_type').value) {
                showError('activity_type', 'Activity type is required');
                isValid = false;
                errors.push('‚ùå Activity Type: Please select a type');
            }

            if (!isValid) {
                alert('‚ö†Ô∏è PLEASE FIX THESE ERRORS:\n\n' + errors.join('\n'));
                return;
            }

            // Create record object
            const record = {
                bin: document.getElementById('bin').value,
                business_name: document.getElementById('business_name').value,
                trade_name: document.getElementById('trade_name').value,
                business_type: document.getElementById('business_type').value,
                dti_no: document.getElementById('dti_no').value,
                sec_no: document.getElementById('sec_no').value,
                cda_no: document.getElementById('cda_no').value,
                tin_no: document.getElementById('tin_no').value,
                email_address: document.getElementById('email_address').value,
                cellphone_no: document.getElementById('cellphone_no').value,
                telephone_no: document.getElementById('telephone_no').value,
                incharge_first_name: document.getElementById('incharge_first_name').value,
                incharge_middle_name: document.getElementById('incharge_middle_name').value,
                incharge_last_name: document.getElementById('incharge_last_name').value,
                incharge_extension_name: document.getElementById('incharge_extension_name').value,
                incharge_sex: sex.value,
                incharge_country_of_citizenship: document.getElementById('incharge_country_of_citizenship').value,
                incharge_street: document.getElementById('incharge_street').value,
                incharge_barangay: document.getElementById('incharge_barangay').value,
                incharge_municipality: document.getElementById('incharge_municipality').value,
                incharge_province: document.getElementById('incharge_province').value,
                office_street: document.getElementById('office_street').value,
                office_barangay_code: document.getElementById('office_barangay_code').value,
                location_owned: locationOwned.value,
                tdn_no: document.getElementById('tdn_no').value,
                pin_no: document.getElementById('pin_no').value,
                lessor_name: document.getElementById('lessor_name').value,
                monthly_rental: document.getElementById('monthly_rental').value,
                area: document.getElementById('area').value,
                no_of_male_employees: document.getElementById('no_of_male_employees').value,
                no_of_female_employees: document.getElementById('no_of_female_employees').value,
                no_of_employees_residing_within_the_area: document.getElementById('no_of_employees_residing_within_the_area').value,
                no_of_van: document.getElementById('no_of_van').value,
                no_of_truck: document.getElementById('no_of_truck').value,
                no_of_motorcycle: document.getElementById('no_of_motorcycle').value,
                activity_type: document.getElementById('activity_type').value
            };

            if(editingIndex !== null){
                records[editingIndex] = record;
                editingIndex = null;
                document.querySelector('.btn-primary').textContent = '‚ûï Add Record';
                alert('‚úÖ Record updated');
            } else {
                records.push(record);
                alert(`‚úÖ Record added successfully! Total records: ${records.length}`);
            }

            saveRecords();
            renderTable();
            updateRecordCount();
            clearForm();
        }

        // Ensure default prefix is present in bin value
        function ensurePrefixApplied(){
            if(!defaultBinPrefix) return;
            const binEl = document.getElementById('bin');
            if(!binEl) return;
            const raw = binEl.value.replace(/[^\d]/g,'');
            if(!raw.startsWith(defaultBinPrefix)){
                // keep rest of digits after first 7 if user typed them
                const rest = raw.slice(7);
                binEl.value = defaultBinPrefix + (rest ? ('-' + rest) : '-');
                binEl.dispatchEvent(new Event('input'));
            }
        }

        function clearForm() {
            document.getElementById('businessForm').reset();
            
            // Reset disabled fields
            document.getElementById('dti_no').disabled = true;
            document.getElementById('sec_no').disabled = true;
            document.getElementById('cda_no').disabled = true;
            document.getElementById('tdn_no').disabled = true;
            document.getElementById('pin_no').disabled = true;
            document.getElementById('lessor_name').disabled = true;
            document.getElementById('monthly_rental').disabled = true;

            // Reset required indicators
            document.getElementById('dti-required').innerHTML = '';
            document.getElementById('sec-required').innerHTML = '';
            document.getElementById('cda-required').innerHTML = '';
            document.getElementById('tdn-required').innerHTML = '';
            document.getElementById('pin-required').innerHTML = '';
            document.getElementById('lessor-required').innerHTML = '';
            document.getElementById('rental-required').innerHTML = '';

            // Clear all error/success states
            document.querySelectorAll('.error, .success').forEach(el => {
                el.classList.remove('error', 'success');
            });
            document.querySelectorAll('.error-message').forEach(el => {
                el.classList.remove('show');
            });

            // Reset default values
            document.getElementById('incharge_country_of_citizenship').value = 'Philippines';
            document.getElementById('no_of_male_employees').value = '0';
            document.getElementById('no_of_female_employees').value = '0';
            document.getElementById('no_of_employees_residing_within_the_area').value = '0';
            document.getElementById('no_of_van').value = '0';
            document.getElementById('no_of_truck').value = '0';
            document.getElementById('no_of_motorcycle').value = '0';

            // reset editing state
            editingIndex = null;
            document.querySelector('.btn-primary').textContent = '‚ûï Add Record';
        }

        function updateRecordCount() {
            document.getElementById('recordCount').textContent = `Records: ${records.length}`;
        }

        function editRecord(idx){
            const r = records[idx];
            if(!r) return;
            // set editing index early
            editingIndex = idx;

            // 1) set business type first so change handler enables the right registration inputs
            if(r.business_type){
                const bt = document.getElementById('business_type');
                if(bt) bt.value = r.business_type;
                if(bt) bt.dispatchEvent(new Event('change'));
            }

            // 2) set location radio early so location change handler runs and enables/disables lease/tdn fields
            if(r.location_owned !== undefined && r.location_owned !== null){
                const loc = document.querySelector(`input[name="location_owned"][value="${r.location_owned}"]`);
                if(loc){ loc.checked = true; loc.dispatchEvent(new Event('change')); }
            }

            // 3) populate all simple inputs/selects by id (except radios handled separately)
            for(const k in r){
                if(k === 'business_type' || k === 'location_owned' || k === 'incharge_sex') continue;
                const el = document.getElementById(k);
                if(el){
                    try{ el.value = r[k] == null ? '' : r[k]; }catch(e){}
                }
            }

            // 4) ensure conditional registration fields (which change handlers sometimes clear) are set explicitly AFTER handlers
            ['dti_no','sec_no','cda_no','tdn_no','pin_no','lessor_name','monthly_rental'].forEach(id => {
                const el = document.getElementById(id);
                if(el && r[id] !== undefined && r[id] !== null){ el.value = r[id]; }
            });

            // 5) set radios (person in charge)
            if(r.incharge_sex){ const radio = document.querySelector(`input[name="incharge_sex"][value="${r.incharge_sex}"]`); if(radio) radio.checked = true; }

            // finalize UI state
            document.querySelector('.btn-primary').textContent = 'üíæ Save Changes';
            // scroll to top so user sees the populated form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function duplicateRecord(idx){
            const r = records[idx]; if(!r) return;
            const copy = JSON.parse(JSON.stringify(r));
            records.splice(idx+1,0,copy);
            saveRecords(); renderTable(); updateRecordCount();
        }

        function deleteRecord(idx){
            if(!confirm('Delete this record?')) return;
            records.splice(idx,1); saveRecords(); renderTable(); updateRecordCount();
        }

        // Generate CSV uses current records (saved)
        function generateCSV() {
            if (records.length === 0) {
                alert('‚ö†Ô∏è No records to generate! Please add at least one record.');
                return;
            }

            const headers = [
                'bin', 'business_name', 'trade_name', 'business_type', 'dti_no', 'sec_no', 'cda_no',
                'tin_no', 'email_address', 'cellphone_no', 'telephone_no', 'incharge_first_name',
                'incharge_middle_name', 'incharge_last_name', 'incharge_extension_name', 'incharge_sex',
                'incharge_country_of_citizenship', 'incharge_street', 'incharge_barangay',
                'incharge_municipality', 'incharge_province', 'office_street', 'office_barangay_code',
                'location_owned', 'tdn_no', 'pin_no', 'lessor_name', 'monthly_rental', 'area',
                'no_of_male_employees', 'no_of_female_employees', 'no_of_employees_residing_within_the_area',
                'no_of_van', 'no_of_truck', 'no_of_motorcycle', 'activity_type'
            ];

            let csv = headers.join(',') + '\n';

            records.forEach(record => {
                const row = headers.map(header => {
                    const value = record[header] || '';
                    // Escape commas and quotes
                    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csv += row.join(',') + '\n';
            });

            // Create download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `business_registration_${timestamp}.csv`;
            
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();

            alert(`‚úÖ CSV file generated successfully!\n\nFilename: ${filename}\nRecords: ${records.length}`);

            if (confirm('Do you want to clear all records and start fresh?')) {
                records = [];
                saveRecords(); renderTable(); updateRecordCount();
            }
        }

    </script>
</body>
</html>